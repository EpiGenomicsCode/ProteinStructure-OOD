#!/bin/bash

<%- if context.session_type == "AlphaFold 2" -%>
# AlphaFold 2 specific logic

# Prepare input sequence
INPUT_SEQUENCE="<%= context.protein_sequence.to_s %>"

# Save input sequence to FASTA file
cat <<EOF > "${FASTA_FILE}"
${INPUT_SEQUENCE}
EOF

echo "Debug: Created FASTA file at ${FASTA_FILE}"

chmod +x "${SESSIONDIR}/alphafold.sh"

bash "${SESSIONDIR}/alphafold.sh" \
    "${FASTA_FILE}" "$USER" "$WORKINGDIR" "<%= context.auto_accounts %>" "$STATUS_FILE" "$TIMESTAMP"

echo "Debug: AlphaFold 2 process launched"

<%- elsif context.session_type == "AlphaFold 3" -%>

JSON_INPUT="<%= context.protein_sequence.to_s %>"

mkdir -p "${INPUT_DIR}" || handle_error "Failed to create input directory"

JSON_INPUT_FILE="${INPUT_DIR}/input.json"
cat <<EOF > "${JSON_INPUT_FILE}"
<%= context.protein_sequence.to_s %>
EOF
echo "Debug: Created JSON input file at ${JSON_INPUT_FILE}"

chmod +x "${SESSIONDIR}/alphafold3.sh"

bash "${SESSIONDIR}/alphafold3.sh" \
    "${JSON_INPUT_FILE}" "$USER" "$WORKINGDIR" "<%= context.auto_accounts %>" "$STATUS_FILE" "$TIMESTAMP"

echo "Debug: AlphaFold 3 job has been launched"

<%- else -%>
echo "Invalid session type. Exiting"
update_status "failed"
exit 1
<%- end -%>