<style>
.progress {
  height: 20px;
  margin: 10px 0;
  background-color: #f5f5f5;
  border-radius: 4px;
}

.progress-bar {
  background-color: #337ab7;
  color: white;
  text-align: center;
  line-height: 20px;
}

.job-status {
  margin: 20px 0;
  padding: 15px;
  background-color: #f8f9fa;
  border-radius: 4px;
}

.log-output {
  font-family: monospace;
  background-color: #f8f9fa;
  padding: 15px;
  border-radius: 4px;
  max-height: 400px;
  overflow-y: auto;
  white-space: pre-wrap;
  font-size: 12px;
}
</style>

<div class="alert alert-info">
  <h4>Protein Structure Prediction Job Information</h4>
  
  <% 
  require 'json'

  # Access working directory and session type from user context
  working_dir = @user_context["working_directory"]
  session_type = @user_context["session_type"]

  # Initialize status hash
  status = {
    phase: 'Initializing',
    progress: 0,
    details: [],
    run_dir: nil
  }

  # Get job status using these values if working directory exists
  if working_dir
    status = get_job_status(working_dir, @id, session_type)
  end
  %>

  <small class="text-muted">The prediction engine utilized for this job is <strong><%= session_type %></strong>, developed by <a href="https://deepmind.google/technologies/alphafold/" target="_blank">DeepMind Technologies Limited</a>.</small>

  <div class="job-status">
    <h5>Current Status</h5>
    <p>Phase: <%= status[:phase] %></p>

    <% if status[:session_type] == 'AlphaFold 2' %>
      <div class="progress">
        <div class="progress-bar" role="progressbar" style="width: <%= status[:progress] %>%">
          <%= status[:progress] %>%
        </div>
      </div>
      
      <% if status[:details].any? %>
        <h5>Details</h5>
        <ul>
          <% status[:details].each do |detail| %>
            <li><%= detail %></li>
          <% end %>
        </ul>
      <% end %>
    <% end %>

    <% if status[:cpu_log_content].present? %>
      <h5>CPU Phase Log</h5>
      <div class="log-output">
<%= status[:cpu_log_content] %>
      </div>
    <% end %>

    <% if status[:gpu_log_content].present? %>
      <h5>GPU Phase Log</h5>
      <div class="log-output">
<%= status[:gpu_log_content] %>
      </div>
    <% end %>
  </div>

  <h5>Job Output Location</h5>
  <p>Working Directory: 
    <a href="/pun/sys/dashboard/files/fs<%= working_dir %>" target="_blank">
      <%= working_dir %>
      <i class="fa fa-external-link"></i>
    </a>
  </p>
  
  <% if status[:run_dir] %>
    <p>Run Directory: 
      <a href="/pun/sys/dashboard/files/fs<%= status[:run_dir] %>" target="_blank">
        <%= status[:run_dir] %>
        <i class="fa fa-external-link"></i>
      </a>
    </p>

    <% if status[:session_type] == 'AlphaFold 2' %>
      <p>Output files will include:</p>
      <ul>
        <li>PDB structures: 
          <% if File.exist?("#{status[:run_dir]}/input/ranked_0.pdb") %>
            <a href="/pun/sys/dashboard/files/fs<%= status[:run_dir] %>/input/ranked_0.pdb?download=1" class="btn btn-sm btn-primary">
              <i class="fa fa-download"></i> Download Best Model
            </a>
          <% else %>
            <span class="text-muted">ranked_*.pdb files will be available in input/ when the GPU phase completes</span>
          <% end %>
        </li>
        
        <li>MSA files: 
          <% if status[:phase].include?("GPU Phase") || status[:script_status] == "completed" %>
            <a href="/pun/sys/dashboard/files/fs<%= status[:run_dir] %>/input/msas" target="_blank">
              <%= status[:run_dir] %>/input/msas/
              <i class="fa fa-external-link"></i>
            </a>
          <% else %>
            <span class="text-muted">MSA files will be available in input/msas/ after CPU phase completes</span>
          <% end %>
        </li>
        
        <li>Log files: 
          <a href="/pun/sys/dashboard/files/fs<%= status[:run_dir] %>/logs" target="_blank">
            <%= status[:run_dir] %>/logs/
            <i class="fa fa-external-link"></i>
          </a>
        </li>
        
        <li>Prediction results: 
          <% if Dir.glob("#{status[:run_dir]}/input/result_*.pkl").any? %>
            <a href="/pun/sys/dashboard/files/fs<%= status[:run_dir] %>/input?download=1&files[]=result_model_1.pkl" class="btn btn-sm btn-primary">
              <i class="fa fa-download"></i> Download Results
            </a>
          <% else %>
            <span class="text-muted">result_*.pkl files will be available in input/ when the GPU phase completes</span>
          <% end %>
        </li>
      </ul>
    <% elsif status[:session_type] == 'AlphaFold 3' %>
      <p>Output files will include:</p>
      <ul>
        <li>Predicted Structure (mmCIF format):
          <% if File.exist?("#{status[:output_dir]}/#{status[:sanitized_job_name]}_model.cif") %>
            <a href="/pun/sys/dashboard/files/fs<%= status[:output_dir] %>/<%= status[:sanitized_job_name] %>_model.cif?download=1" class="btn btn-sm btn-primary">
              <i class="fa fa-download"></i> Download Best Model
            </a>
          <% else %>
            <span class="text-muted"><%= status[:sanitized_job_name] %>_model.cif file will be available in the output directory when the GPU phase completes</span>
          <% end %>
        </li>
        
        <li>Confidence Metrics:
          <% if File.exist?("#{status[:output_dir]}/#{status[:sanitized_job_name]}_confidences.json") %>
            <a href="/pun/sys/dashboard/files/fs<%= status[:output_dir] %>/<%= status[:sanitized_job_name] %>_confidences.json?download=1" target="_blank">
              View Confidence Metrics
              <i class="fa fa-external-link"></i>
            </a>
          <% else %>
            <span class="text-muted">Confidence metrics will be available in the output directory when the GPU phase completes</span>
          <% end %>
        </li>
        
        <li>All Predictions:
          <% if Dir.exist?(status[:output_dir]) && Dir.glob("#{status[:output_dir]}/seed-*").any? %>
            <a href="/pun/sys/dashboard/files/fs<%= status[:output_dir] %>" target="_blank">
              <%= status[:output_dir] %>/
              <i class="fa fa-external-link"></i>
            </a>
            <p class="text-muted">Contains sub-directories for each seed and sample with detailed outputs.</p>
          <% else %>
            <span class="text-muted">Prediction results will be available in the output directory when the GPU phase completes</span>
          <% end %>
        </li>

        <li>Input JSON with Added MSA and Template Data:
          <% if File.exist?("#{status[:output_dir]}/#{status[:sanitized_job_name]}_data.json") %>
            <a href="/pun/sys/dashboard/files/fs<%= status[:output_dir] %>/<%= status[:sanitized_job_name] %>_data.json?download=1" target="_blank">
              View Input JSON Data
              <i class="fa fa-external-link"></i>
            </a>
          <% else %>
            <span class="text-muted">Input JSON with MSA and template data will be available in the output directory when the GPU phase completes</span>
          <% end %>
        </li>

        <li>Ranking Scores:
          <% if File.exist?("#{status[:output_dir]}/ranking_scores.csv") %>
            <a href="/pun/sys/dashboard/files/fs<%= status[:output_dir] %>/ranking_scores.csv?download=1" target="_blank">
              Download Ranking Scores
              <i class="fa fa-download"></i>
            </a>
          <% else %>
            <span class="text-muted">Ranking scores will be available in the output directory when the GPU phase completes</span>
          <% end %>
        </li>
        
        <li>Log files: 
          <a href="/pun/sys/dashboard/files/fs<%= status[:run_dir] %>/logs" target="_blank">
            <%= status[:run_dir] %>/logs/
            <i class="fa fa-external-link"></i>
          </a>
        </li>
      </ul>
    <% end %>

    <% if status[:script_status] == "completed" %>
      <div class="alert alert-success">
        <h5>Job Completed Successfully!</h5>
        <p>All output files are now available in the output directories.</p>
        <a href="/pun/sys/dashboard/files/fs<%= status[:run_dir] %>" class="btn btn-primary" target="_blank">
          <i class="fa fa-folder-open"></i> Browse All Files
        </a>
      </div>
    <% elsif status[:script_status] == "failed" %>
      <div class="alert alert-danger">
        <h5>Job Failed</h5>
        <p>Please check the logs for more details.</p>
      </div>
    <% end %>
  <% else %>
    <p>Run directory will be created when the job starts...</p>
  <% end %>

</div>
</div>
