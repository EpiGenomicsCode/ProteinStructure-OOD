<%-
  cmd="/storage/sys/slurm/bin/sacctmgr -p -n show user $USER withassoc| awk -F \"|\" '{print $5}'"
  allocations = []
  user = User.new
  cache_dir = File.join(ENV['HOME'], '.ood_cache', 'pterminal')
  FileUtils.mkdir_p(cache_dir) unless File.exist?(cache_dir)
  cache = ActiveSupport::Cache::FileStore.new(cache_dir, expires_in: 12.hours)
  cache.cleanup()
  allocations = cache.fetch('allocations', race_condition_ttl: 10.seconds) do
    callocations = []
    begin
      output, status = Open3.capture2e(cmd)
      if status.success?
        callocations = output.split("\n").map(&:strip).reject(&:blank?).sort
      else
        raise output
      end
    rescue => e
      callocations = []
      error = e.message.strip
    end
    callocations
  end
-%>
---
title: "Protein Prediction"
cluster: "rc"

form:
  - session_type
  - rc_account
  - working_directory
  - input_sequence

attributes:

  rc_account:
    label: "Allocation for Structure Prediction Phase (GPU Phase)"
    help: "Please select a GPU allocation from the drop-down"
    widget: select
    options:
  <%- if !allocations.blank? -%>
    <%- allocations.each do |a| -%>
      - [ "<%= a %>", "<%= a %>" ]
    <%- end -%>
  <%- end -%>

  session_type:
    label: "Protein Prediction Engine"
    help: "NOTE: AlphaFold is more accurate, ESMFold is faster"
    widget: select
    options:
      - ["AlphaFold", "AlphaFold"]

  input_sequence:
    label: Input Amino Acid Sequence (FASTA Format)
    widget: text_area
    pattern: "^(>.+\n([ACDEFGHIKLMNPQRSTVWY]+(\n|$))+)+"
    value: |
      >Seq1
      LYLIFGAWAGMVGTALSLLIRAELGQPGTLLGDDQIYNVIVTAHAFVMIFFMVMPIMIGGFGNWLVPLMI
    help: |
      - Runtime increases with sequence length

  working_directory:
    label: "Working Directory"
    help: "Select or enter the path for the working directory"
    widget: "path_selector"
    directory: "/storage/home/<%= ENV['USER'] %>"
    value: "/storage/home/<%= ENV['USER'] %>/AlphaFold"
    show_hidden: false
    show_files: false
    favorites:
      - "/storage/home/<%= ENV['USER'] %>"
      - "/storage/work/<%= ENV['USER'] %>"
      - "/storage/group"
